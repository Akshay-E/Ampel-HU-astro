name: ligo-healpix

mongo:
  prefix: dumpme
  reset: true

channel:
- name: ligo
  access: [ZTF, ZTF_PUB, ZTF_PRIV]
  policy: []



task:

- title: HealpixToAlertToken
  unit: T3Processor
  config:
    raise_exc: true
    execute:
      - unit: T3PlainUnitExecutor
        config:
          target:
            unit: HealpixTokenGenerator
            config:
              pvalue_limit: 0.9 
              map_name: "S191222n.fits.gz" 
              map_url: "https://gracedb.ligo.org/api/superevents/S191222n/files/LALInference.fits.gz"
              map_dir: '/home/jnordin/tmp'
              archive_token:
                label: ztf/archive/token
- title: ProcessAlerts
  unit: AlertConsumer
  config:
    iter_max: 1000000
    supplier:
      unit: ZiAlertSupplier
      config:
        deserialize: null
        loader:
          unit: ZTFArchiveAlertLoader
          config:
            resource_name: "S191222n.fits.gz_token"
    shaper: ZiDataPointShaper
    directives:
    - channel: ligo
      filter:
        config:
          gaia_excessnoise_sig_max: 999
          gaia_plx_signif: 3
          gaia_pm_signif: 3
          gaia_rs: 20
          gaia_veto_gmag_max: 20
          gaia_veto_gmag_min: 9
          min_ndet: 1
          min_tspan: -99
          max_tspan: 99
          min_archive_tspan: -99
          max_archive_tspan: 100
          min_drb: 0.995
          min_gal_lat: 14
          min_rb: 0.3
          min_sso_dist: 20
          ps1_confusion_rad: 3
          ps1_confusion_sg_tol: 0.1
          ps1_sgveto_rad: 1
          ps1_sgveto_th: 0.8
          max_fwhm: 5.5
          max_elong: 2
          max_magdiff: 1
          max_nbad: 2
        on_stock_match: bypass
        unit: DecentFilter
      ingest:
        mux:
          unit: ZiMongoMuxer
          insert:
            point_t2:
            - config: &catalog_match_config
                catalogs:
                  SDSS_spec:
                    keys_to_append:
                    - z
                    - bptclass
                    - subclass
                    rs_arcsec: 10.
                    use: extcats
                    all: False
                  LSPhotoZZou:
                    keys_to_append:
                    - photoz
                    - ra
                    - dec
                    - e_photoz
                    - specz
                    - _6
                    - logMassBest
                    - logMassInf
                    - logMassSup
                    rs_arcsec: 10.
                    use: extcats
                    pre_filter: null
                    post_filter: null
                    all: False
                  PS1_photoz:
                    keys_to_append:
                    - raMean
                    - decMean
                    - z_phot
                    - z_photErr
                    - z_phot0
                    - _2
                    rs_arcsec: 10.
                    use: extcats
                    pre_filter: null
                    post_filter: null
              ingest:
                filter: PPSFilter
                select: first
                sort: jd
              unit: T2CatalogMatch
              
          unit: ZiMongoMuxer

- title: Run T2s
  unit: T2Worker
  config:
    send_beacon: false
    raise_exc: true

